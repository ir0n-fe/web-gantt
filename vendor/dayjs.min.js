(function(g){
  function toDate(input, format, strict){
    if(input && input._d instanceof Date){ return new Date(input._d.getTime()); }
    if(input instanceof Date){ return new Date(input.getTime()); }
    if(typeof input === 'string'){
      if((format === 'YYYY-MM-DD' || !format) && /^\d{4}-\d{2}-\d{2}$/.test(input)){
        var y = Number(input.slice(0,4));
        var m = Number(input.slice(5,7)) - 1;
        var d = Number(input.slice(8,10));
        var dt = new Date(y,m,d);
        if(strict && (dt.getFullYear()!==y || dt.getMonth()!==m || dt.getDate()!==d)){ return new Date(NaN); }
        return dt;
      }
      var parsed = new Date(input);
      return isNaN(parsed.getTime()) ? new Date(NaN) : parsed;
    }
    if(typeof input === 'number'){ return new Date(input); }
    if(input == null){ return new Date(); }
    return new Date(input);
  }

  function pad(v){ return String(v).padStart(2,'0'); }

  function Day(d){ this._d = d; }
  Day.prototype.isValid = function(){ return !isNaN(this._d.getTime()); };
  Day.prototype.startOf = function(unit){
    var d = new Date(this._d.getTime());
    if(unit === 'day'){ d.setHours(0,0,0,0); }
    return new Day(d);
  };
  Day.prototype.add = function(v, unit){
    var d = new Date(this._d.getTime());
    if(unit === 'day'){ d.setDate(d.getDate()+Number(v||0)); }
    return new Day(d);
  };
  Day.prototype.subtract = function(v, unit){ return this.add(-Number(v||0), unit); };
  Day.prototype.day = function(){ return this._d.getDay(); };
  Day.prototype.format = function(fmt){
    if(fmt === 'YYYY-MM-DD'){
      return this._d.getFullYear() + '-' + pad(this._d.getMonth()+1) + '-' + pad(this._d.getDate());
    }
    return this._d.toISOString();
  };
  Day.prototype.isBefore = function(other, unit){
    var o = dayjs(other);
    if(unit === 'day'){ return this.startOf('day')._d.getTime() < o.startOf('day')._d.getTime(); }
    return this._d.getTime() < o._d.getTime();
  };
  Day.prototype.isAfter = function(other, unit){
    var o = dayjs(other);
    if(unit === 'day'){ return this.startOf('day')._d.getTime() > o.startOf('day')._d.getTime(); }
    return this._d.getTime() > o._d.getTime();
  };
  Day.prototype.diff = function(other, unit){
    var o = dayjs(other);
    if(unit === 'day'){
      var a = this.startOf('day')._d.getTime();
      var b = o.startOf('day')._d.getTime();
      return Math.round((a-b)/86400000);
    }
    return this._d.getTime()-o._d.getTime();
  };

  function dayjs(input, format, strict){ return new Day(toDate(input, format, strict)); }
  dayjs.extend = function(){};
  g.dayjs = dayjs;
})(window);
